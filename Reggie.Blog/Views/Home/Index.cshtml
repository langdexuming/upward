@model List<Reggie.Blog.Models.InformalEssay>;
@{
    //注入
    // @inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

    ViewData["Title"] = "Langdexuming' Blog";
}


<style>
    #content {
        color: #262626;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    #main-content {
        min-height: 480px;
        /* background: gray; */
        min-height: 480px;
        /* max-height: 500px; */
        padding: 10px 20px 0px 0px;
    }

        #main-content .header {
            color: #262626;
            height: 64px;
            border-radius: 2px;
            background: #fff;
            margin-bottom: 12px;
            /* box-shadow: 0 1px 3px rgba(0, 0, 0, .1); */
            box-shadow: 0 1px 12px rgba(0, 0, 0, .1);
            box-sizing: border-box;
            line-height: 58px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            font-size: 16px;
            /* justify-content: space-between; */
            padding: 3px 6px;
            overflow: hidden;
        }

            #main-content .header .btn {
                border-width: 0px;
                padding: 6px 12px;
                font-size: 16px;
                line-height: 20px;
                display: inline-block;
            }

            #main-content .header svg {
                vertical-align: middle;
                margin: auto 6px 1px 0px;
            }

    .Icon {
        vertical-align: text-bottom;
        fill: #9fadc7;
    }

    ul.list-group {
        margin: 0;
        padding: 0;
        /*box-shadow: 0 1px 12px rgba(0, 0, 0, .1);*/
        color: #262626;
        border-radius: 2px;
        background: transparent;
    }

    .list-group-item {
        /* padding-left: 0px; */
        margin: 0px 0px 12px 0px;
        box-shadow: 0 1px 12px rgba(0, 0, 0, .1);
        background: #fff;
        border-radius: 2px;
    }

    .TopstoryHeader-rightItem {
        color: #8590a6;
        -webkit-transition: color .2s ease-in;
        transition: color .2s ease-in;
        cursor: pointer;
        float: right;
        margin-right: 12px;
    }

    .header .nav {
        float: left;
    }

    .list-group-item {
        min-height: 64px;
        text-overflow: clip;
    }

        .list-group-item .title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            line-height: 22px;
            cursor: pointer;
        }

        .list-group-item .message {
            white-space: pre-wrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            line-height: 20px;
            max-height: 80px;
            /* 解决一长串数字、英文字母连在一起时不能自动换行*/
            word-break: break-all;
            word-wrap: break-word;
        }

            .list-group-item .message a {
                cursor: pointer;
                margin-left: 3px;
            }

    #loadingCircle {
        margin-top: 20px;
        display: none;
    }

        #loadingCircle .sk-spinner-fading-circle {
            width: 64px;
            height: 64px;
        }

        #loadingCircle p {
            margin-top: 5px;
            color: #262626;
        }
</style>

    @*海报*@
    @Html.Partial("_IndexPosterPartial")

    @*用于定位导航条变换位置*@
    <div id="posterBottom"></div>

    @*主要内容：新建随笔，博客列表*@
    <div id="content" class="container">
        <div id="main-content" class=" col-md-9">
            @{
                if(ViewBag.CanCreateInformalEssay)
                {
               <div class="header">
                <div class="nav">
                    <a id="btnInformalEssay" class="btn btn-default" asp-controller="Home" asp-action="CreateInformalEssay">
                        <svg width="16" height="16" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg" class="Icon Icon--write" aria-hidden="true"
                            style="height: 16px; width: 16px;">
                            <g>
                                <g fill="none" fill-rule="evenodd">
                                    <path d="M9.595 2.023H4.842c-2.22 0-4.01 1.793-4.01 4.005v7.62c0 2.21 1.796 4.003 4.01 4.003h7.316c2.22 0 4.01-1.792 4.01-4.003v-7.11.51L14.523 8.72v4.253c0 1.66-1.336 3.004-3.01 3.004h-6.03c-1.66 0-3.008-1.338-3.008-3.004V6.7c0-1.657 1.336-3.002 3.01-3.002h2.467L9.595 2.03v-.007z"
                                        fill="#8590A6"></path>
                                    <path d="M6.372 11.08c-.185-.915.2-2.238.85-2.888l6.616-6.616c.565-.565 1.472-.567 2.038 0 .56.56.56 1.477 0 2.038L9.258 10.23c-.652.65-1.975 1.034-2.888.85z"
                                        stroke="#8590A6" stroke-width="1.5"></path>
                                    <path fill="#8590A6" d="M13.04 2.088l2.324 2.324-.987.986-2.323-2.324z"></path>
                                </g>
                            </g>
                        </svg>随笔</a>
                </div>
                        </div>
                }
            }
                <ul id="informalEssayList" class="list-group">

                </ul>
                <div id="loadingCircle" class="ibox-content">
                    <div class="spiner-example">
                        <div class="sk-spinner sk-spinner-fading-circle">
                            <div class="sk-circle1 sk-circle"></div>
                            <div class="sk-circle2 sk-circle"></div>
                            <div class="sk-circle3 sk-circle"></div>
                            <div class="sk-circle4 sk-circle"></div>
                            <div class="sk-circle5 sk-circle"></div>
                            <div class="sk-circle6 sk-circle"></div>
                            <div class="sk-circle7 sk-circle"></div>
                            <div class="sk-circle8 sk-circle"></div>
                            <div class="sk-circle9 sk-circle"></div>
                            <div class="sk-circle10 sk-circle"></div>
                            <div class="sk-circle11 sk-circle"></div>
                            <div class="sk-circle12 sk-circle"></div>
                        </div>
                    </div>
                    <p class=" text-center">加载中，请稍后...</p>
                </div>
            </div>

        @*侧边栏*@
        @Html.Partial("_IndexSideBarPartial")
    </div>

@section Scripts 
{
<script lang=”javascript” type="text/javascript">

    /*
    * 阅读全文
    *
    */
    function ReadFullText(self) {

        var pElement = self.parentNode;

        //1级
        if (!pElement.classList.contains("list-group-item")) {
            //2级
            pElement = pElement.parentNode;
        }

        if (!pElement.classList.contains("list-group-item")) {
            return;
        }

        var dataId = $(pElement).attr('data-id');

        window.location.href = "/Home/InformalEssayDetail?id=" + dataId;
    }

    /*
     * 生成随笔对应的Html
     *
     */
    function GenerateInformalEssayHtml(informalEssay) {
        var content = informalEssay.message;

        var createDateTimeStr = informalEssay.createDateTime;
        var dotIndex = informalEssay.createDateTime.indexOf('.');
        if (dotIndex > 0)
        {
            createDateTimeStr = createDateTimeStr.substring(0, dotIndex);
        }
        createDateTimeStr = createDateTimeStr.replace("T", " ");
        var source = "<p class=\"text-right\" style=\"color:#999;\">" + "posted @@ " + createDateTimeStr + "&nbsp;&nbsp;&nbsp;by&nbsp;&nbsp;<span>" + informalEssay.userName + "</span></p>";

        return "<li class=\"list-group-item\" data-id=\"" + informalEssay.id + "\"><a href=\"javascript:void(0);\" onclick=\"ReadFullText(this)\"><h4 class=\"title\">" + informalEssay.title +
            "</h4></a><div class=\"message\">" + content + "<a href=\"javascript:void(0);\" onclick=\"ReadFullText(this)\">阅读全文</a></div>" + source +
            "</li>";
    }

        var isInformalEssayLoading = false;
        var hasMoreInformalEssays = true;

        /*
         * 加载随笔
         *
         */
        function InformalEssayLoad() {
            if (!hasMoreInformalEssays || isInformalEssayLoading) {
                return;
            }

            isInformalEssayLoading = true;

            //显示加载动画
            $('#loadingCircle').css("display", "block");

            //域内请求
            var lastId = -1;
            var children = $("#informalEssayList").children();
            if (children !== null && children.length !== 0) {
                lastId = children.last().attr('data-id');
            }

            var options = {
                url: '/Home/SearchInformalEssay?lastId=' + lastId,
                dataType: 'text',
                success: function (data) {
                    if (data.length > 0) {
                        console.log('请求成功，数据长度为:' + data.length);
                        //解析Json字符串
                        var dataArray = eval("(" + data + ")");
                        if (dataArray.length !== 0) {
                            for (var i = 0; i < dataArray.length; i++) {
                                var dataObj = dataArray[i];
                                $("#informalEssayList").append(GenerateInformalEssayHtml(dataObj));

                                // console.log(dataObj.title);
                                // console.log(dataObj.message);
                                // console.log(dataObj.userName);
                                // console.log(dataObj.createDateTime);
                                // console.log(dataObj.sourceType);
                            }
                        }
                        else {
                            hasMoreInformalEssays = false;
                        }

                    } else {
                        hasMoreInformalEssays = false;
                    }
                },
                complete: function () {
                    isInformalEssayLoading = false;
                    $('#loadingCircle').css("display", "none");
                }
            };

            $.ajax(options);
        }

        /*
         * 是否需要加载问题，由当前页面滚动区域Top位置决定
         *
         */
        function IsNeedLoadInformalEssay() {
            var docScrollTop = document.documentElement.scrollTop || window.pageYOffset || document.body.scrollTop;
            var children = $("#informalEssayList").children();
            var lastElement = children.last();
            var targetOffsetTop = lastElement.offset().top;
            if (targetOffsetTop - docScrollTop < document.documentElement.clientHeight) {
                return true;
            }
            return false;
        }

        /*
         *
         *
         */
        $(function () {

            $(document).scroll(function () {
                //是否需要加载
                if (IsNeedLoadInformalEssay()) {
                    InformalEssayLoad();
                }
            });

            //加载随笔
            InformalEssayLoad();

        });
</script>
}



